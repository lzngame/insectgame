var jsonData = '{"slice156_@.png": [[606, 200, 117, 157], [0, 0], 0, [0, 0, 117, 157], [117, 157]], "f35_35.png": [[379, 154, 10, 10], [0, 0], 0, [0, 0, 10, 10], [10, 10]], "slice46_46.png": [[949, 173, 72, 79], [0, 0], 0, [0, 0, 72, 79], [72, 79]], "slice02_02.png": [[378, 445, 41, 52], [0, 0], 1, [0, 0, 41, 52], [41, 52]], "flowers06_06.png": [[758, 136, 138, 189], [0, 0], 1, [0, 0, 138, 189], [138, 189]], "slice03_03.png": [[110, 522, 43, 52], [0, 0], 1, [0, 0, 43, 52], [43, 52]], "slice18_18.png": [[164, 523, 41, 52], [0, 0], 1, [0, 0, 41, 52], [41, 52]], "slice73_73.png": [[221, 385, 48, 52], [0, 0], 1, [0, 0, 48, 52], [48, 52]], "f48_48.png": [[928, 320, 117, 88], [0, 0], 1, [0, 0, 117, 88], [117, 88]], "slice77_77.png": [[2, 432, 48, 52], [0, 0], 1, [0, 0, 48, 52], [48, 52]], "slice53_53.png": [[378, 488, 40, 45], [0, 0], 1, [0, 0, 40, 45], [40, 45]], "slice152_@.png": [[725, 324, 28, 35], [0, 0], 0, [0, 0, 28, 35], [28, 35]], "slice71_71.png": [[126, 330, 53, 43], [0, 0], 0, [0, 0, 53, 43], [53, 43]], "slice21_21.png": [[218, 485, 41, 52], [0, 0], 1, [0, 0, 41, 52], [41, 52]], "f46_46.png": [[758, 2, 132, 224], [0, 0], 1, [0, 0, 132, 224], [132, 224]], "slice23_23.png": [[236, 331, 41, 52], [0, 0], 0, [0, 0, 41, 52], [41, 52]], "slice91_91.png": [[949, 136, 35, 33], [0, 0], 1, [0, 0, 35, 33], [35, 33]], "slice04_04.png": [[433, 438, 41, 52], [0, 0], 1, [0, 0, 41, 52], [41, 52]], "f26_26.png": [[552, 359, 171, 161], [0, 0], 0, [0, 0, 171, 161], [171, 161]], "slice51_51.png": [[949, 254, 64, 72], [0, 0], 1, [0, 0, 64, 72], [64, 72]], "slice76_76.png": [[56, 471, 48, 52], [0, 0], 1, [0, 0, 48, 52], [48, 52]], "slice82_82.png": [[167, 376, 52, 50], [0, 0], 0, [0, 0, 52, 50], [52, 50]], "flowers10_10.png": [[395, 111, 209, 119], [0, 0], 0, [0, 0, 209, 119], [209, 119]], "slice17_17.png": [[842, 439, 56, 85], [0, 0], 1, [0, 0, 56, 85], [56, 85]], "slice67_67.png": [[166, 428, 48, 52], [0, 0], 1, [0, 0, 48, 52], [48, 52]], "slice08_08.png": [[333, 412, 43, 52], [0, 0], 0, [0, 0, 43, 52], [43, 52]], "slice07_07.png": [[433, 395, 41, 52], [0, 0], 1, [0, 0, 41, 52], [41, 52]], "flowers30_30.png": [[398, 2, 107, 358], [0, 0], 1, [0, 0, 107, 358], [107, 358]], "slice131_@.png": [[328, 466, 48, 48], [0, 0], 0, [0, 0, 48, 48], [48, 48]], "slice19_19.png": [[57, 376, 43, 53], [0, 0], 1, [0, 0, 43, 53], [43, 53]], "slice56_56.png": [[606, 111, 150, 41], [0, 0], 0, [0, 0, 150, 41], [150, 41]], "slice129_@.png": [[65, 272, 57, 59], [0, 0], 1, [0, 0, 57, 59], [57, 59]], "slice01_01.png": [[274, 464, 43, 52], [0, 0], 1, [0, 0, 43, 52], [43, 52]], "f27_27.png": [[379, 232, 171, 161], [0, 0], 0, [0, 0, 171, 161], [171, 161]], "slice37_37.png": [[753, 439, 87, 82], [0, 0], 0, [0, 0, 87, 82], [87, 82]], "slice61_61.png": [[56, 521, 48, 52], [0, 0], 1, [0, 0, 48, 52], [48, 52]], "slice28_28.png": [[725, 435, 26, 25], [0, 0], 0, [0, 0, 26, 25], [26, 25]], "slice94_94.png": [[272, 509, 43, 49], [0, 0], 1, [0, 0, 43, 49], [43, 49]], "slice05_05.png": [[164, 478, 43, 52], [0, 0], 1, [0, 0, 43, 52], [43, 52]], "flowers28_28.png": [[2, 99, 281, 106], [0, 0], 0, [0, 0, 281, 106], [281, 106]], "metadata": [[2], [], [], []], "slice22_22.png": [[181, 331, 43, 53], [0, 0], 1, [0, 0, 43, 53], [43, 53]], "slice63_63.png": [[516, 485, 33, 33], [0, 0], 0, [0, 0, 33, 33], [33, 33]], "slice79_79.png": [[984, 37, 39, 37], [0, 0], 1, [0, 0, 39, 37], [39, 37]], "slice38_38.png": [[606, 154, 44, 133], [0, 0], 1, [0, 0, 44, 133], [44, 133]], "slice130_@.png": [[2, 330, 47, 53], [0, 0], 1, [0, 0, 47, 53], [47, 53]], "slice132_@.png": [[285, 99, 108, 53], [0, 0], 0, [0, 0, 108, 53], [108, 53]], "slice39_39.png": [[280, 316, 64, 46], [0, 0], 0, [0, 0, 64, 46], [64, 46]], "slice69_69.png": [[333, 364, 44, 46], [0, 0], 0, [0, 0, 44, 46], [44, 46]], "f32_32.png": [[984, 147, 19, 19], [0, 0], 0, [0, 0, 19, 19], [19, 19]], "slice65_65.png": [[112, 420, 50, 52], [0, 0], 1, [0, 0, 50, 52], [50, 52]], "slice14_14.png": [[146, 267, 61, 66], [0, 0], 1, [0, 0, 61, 66], [61, 66]], "slice74_74.png": [[279, 364, 48, 52], [0, 0], 1, [0, 0, 48, 52], [48, 52]], "slice15_15.png": [[432, 481, 47, 45], [0, 0], 0, [0, 0, 47, 45], [47, 45]], "f34_34.png": [[741, 154, 15, 16], [0, 0], 0, [0, 0, 15, 16], [15, 16]], "slice57_57.png": [[2, 532, 48, 52], [0, 0], 1, [0, 0, 48, 52], [48, 52]], "slice41_41.png": [[285, 154, 92, 92], [0, 0], 0, [0, 0, 92, 92], [92, 92]], "slice78_78.png": [[725, 361, 35, 28], [0, 0], 1, [0, 0, 35, 28], [35, 28]], "slice06_06.png": [[487, 395, 41, 52], [0, 0], 1, [0, 0, 41, 52], [41, 52]], "slice25_25.png": [[552, 315, 41, 52], [0, 0], 1, [0, 0, 41, 52], [41, 52]], "slice30_30.png": [[2, 207, 63, 70], [0, 0], 1, [0, 0, 63, 70], [63, 70]], "slice36_36.png": [[214, 267, 62, 64], [0, 0], 1, [0, 0, 62, 64], [62, 64]], "slice70_70.png": [[725, 398, 35, 26], [0, 0], 1, [0, 0, 35, 26], [35, 26]], "f02_122.png": [[1005, 147, 17, 17], [0, 0], 0, [0, 0, 17, 17], [17, 17]], "slice13_13.png": [[2, 272, 56, 61], [0, 0], 1, [0, 0, 56, 61], [56, 61]], "slice92_92.png": [[323, 516, 33, 33], [0, 0], 0, [0, 0, 33, 33], [33, 33]], "slice42_42.png": [[275, 414, 48, 52], [0, 0], 1, [0, 0, 48, 52], [48, 52]], "slice89_89.png": [[725, 232, 90, 28], [0, 0], 1, [0, 0, 90, 28], [90, 28]], "slice64_64.png": [[552, 232, 81, 52], [0, 0], 1, [0, 0, 81, 52], [81, 52]], "slice52_52.png": [[379, 395, 48, 52], [0, 0], 1, [0, 0, 48, 52], [48, 52]], "slice10_10.png": [[725, 200, 30, 31], [0, 0], 1, [0, 0, 30, 31], [30, 31]], "slice40_40.png": [[220, 435, 48, 52], [0, 0], 1, [0, 0, 48, 52], [48, 52]], "slice24_24.png": [[57, 331, 43, 53], [0, 0], 1, [0, 0, 43, 53], [43, 53]], "slice80_80.png": [[481, 485, 33, 33], [0, 0], 0, [0, 0, 33, 33], [33, 33]], "slice09_09.png": [[74, 207, 63, 70], [0, 0], 1, [0, 0, 63, 70], [63, 70]], "slice153_@.png": [[842, 497, 56, 80], [0, 0], 1, [0, 0, 56, 80], [56, 80]], "slice29_29.png": [[2, 379, 51, 52], [0, 0], 1, [0, 0, 51, 52], [51, 52]], "slice75_75.png": [[2, 482, 48, 52], [0, 0], 1, [0, 0, 48, 52], [48, 52]], "slice60_60.png": [[487, 438, 47, 45], [0, 0], 0, [0, 0, 47, 45], [47, 45]], "slice88_88.png": [[984, 115, 30, 37], [0, 0], 1, [0, 0, 30, 37], [30, 37]], "slice81_81.png": [[984, 78, 37, 35], [0, 0], 0, [0, 0, 37, 35], [37, 35]], "slice90_90.png": [[56, 421, 48, 52], [0, 0], 1, [0, 0, 48, 52], [48, 52]], "flowers04_04.png": [[2, 2, 394, 95], [0, 0], 0, [0, 0, 394, 95], [394, 95]], "slice87_87.png": [[284, 248, 66, 66], [0, 0], 0, [0, 0, 66, 66], [66, 66]], "slice20_20.png": [[112, 375, 43, 53], [0, 0], 1, [0, 0, 43, 53], [43, 53]], "slice72_72.png": [[146, 207, 58, 67], [0, 0], 1, [0, 0, 58, 67], [58, 67]], "slice43_43.png": [[924, 505, 76, 76], [0, 0], 0, [0, 0, 76, 76], [76, 76]], "slice33_33.png": [[218, 528, 36, 49], [0, 0], 1, [0, 0, 36, 49], [36, 49]], "slice62_62.png": [[110, 472, 48, 52], [0, 0], 1, [0, 0, 48, 52], [48, 52]], "slice68_68.png": [[215, 207, 58, 67], [0, 0], 1, [0, 0, 58, 67], [58, 67]], "slice66_66.png": [[984, 2, 33, 38], [0, 0], 1, [0, 0, 33, 38], [33, 38]], "f37_37.png": [[755, 276, 171, 161], [0, 0], 0, [0, 0, 171, 161], [171, 161]], "slice93_93.png": [[929, 439, 64, 80], [0, 0], 1, [0, 0, 64, 80], [64, 80]]}';
var jsonObj = JSON.parse(jsonData);

var mainview_Uiconfig = {
	bg:'#101420',
	hexagonfillclr:'#273F7E',
	fontclr:'#FFFFFF',
	titleClr:'#FBF7EE'
};

titleTooltipHeight = 75;
titleTooltipWidth = 260;
var clrar =['#ffccdd','#ccddff','#ededfc','#efefaa','#ccffee','#eaefea'];

var tmpdata ={
	introduction:['虫巢是幼虫的孵化场所','大部分的成虫都由','对应等级的幼虫孵化而来','及时升级虫巢'],
};

var keyinfos = {
	mapkey:'/getinsectinfo/mapdata',
	bugskey:'/getinsectinfo/bugsdata',
	depotkey:'/getinsectinfo/depotdata',
	
	goodsconfigkey:'/getinsectinfo/goodsinfo',
	bugsconfigkey:'/getinsectinfo/bugsinfo',
	landformconfigkey:'/getinsectinfo/landforminfo',
	enemyconfigkey:'/getinsectinfo/enemyinfo',
}

var depotdataObjArray = [];
var bugsdataObjArray = [];

var titleArray = {
	'/getinsectinfo/bugsdata':{
		localkey:'bugsdata',
		infoobj:null,
		finishedid:false
	},
	'/gethomedata':{
		localkey:'homedata',
		infoobj:null,
		finishedid:false
	},
	'/getinsectinfo/mapdata':{
		localkey:'mapdataInfo',
		infoobj:null,
		finishedid:false
	},
	'/getinsectinfo/depotdata':{
		localkey:'depotInfo',
		infoobj:null,
		finishedid:false
	},
	'/getinsectinfo/goodsinfo':{
		localkey:'goodsconfigInfo',
		infoobj:null,
		finishedid:false
	},
	'/getinsectinfo/landforminfo':{
		localkey:'landforminfo',
		infoobj:null,
		finishedid:false
	},
	'/getinsectinfo/bugsinfo':{
		localkey:'bugsinfo',
		infoobj:null,
		finishedid:false
	},
	'/getinsectinfo/enemyinfo':{
		localkey:'enemyinfo',
		infoobj:null,
		finishedid:false
	}
};

var img_sencha = new Image();
var img_map = new Image();

function initBugsdata(){
	var objdata = titleArray[keyinfos.bugskey].infoobj;
	for(var i in objdata){
		var item = objdata[i];
		var config = getBugsConfigItem(item.id);
		bugsdataObjArray.push({
			id:item.id,
			name:config.name,
			power:item.power,
			classnote:config.classnote,
			count:item.count,
			lv:item.lv,
			description:config.description
		});
	}
	console.log('设置虫群数据');
	bugstore.setData(bugsdataObjArray);
}

function excuteBugsdata(id,num){
	var finditem = getBugsDataItem(id);
	debugger;
	if(finditem != null){
		changeItemCount(bugstore,finditem,id,num);
	}else{
		addBugsdata(id,num);
	}
	saveData('bugsdata');
}

function addBugsdata(gid,num){
	var configitem = getBugsConfigItem(gid);
	bugstore.add({
		name:configitem.name.toString(),
		id:gid,
		count:num,
		power:configitem.defaultpower,
		classnote:configitem.classnote,
		lv:parseInt(configitem.defaultlv),
		description:configitem.description.toString(),
	});
	titleArray[keyinfos.bugskey].infoobj.push({id:gid,lv:configitem.defaultlv,count:num,power:configitem.defaultpower});
}



function initDepotdata(){
	var objdata = titleArray[keyinfos.depotkey].infoobj;
	for(var i in objdata){
		var item = objdata[i];
		var config = getGoodsConfigItem(item.id);
		var notetxt = config.description;
		if(config.isuse == 't'){
			notetxt = notetxt+'<br/>点击开始使用';
		}
		var itemobj = {
			id:item.id,
			name:config.name,
			count:item.count,
			description:notetxt,
			lv:config.lv
		};
		depotdataObjArray.push(itemobj);
	}
	console.log('设置仓库数据');
	depotstore.setData(depotdataObjArray);
}

function excuteDepotdata(id,num){
	var finditem = getGoodsDepotItem(id);
	if(finditem != null){
		changeItemCount(depotstore,finditem,id,num);
	}else{
		addDepotdata(id,num);
	}
	saveData('depotdata');
}

function changeItemCount(targetstore,finditem,id,num){
	var sum = parseInt(finditem.count) + num;
	finditem.count = sum;
	
	var objtmp = targetstore.getRange();
	for(var j in objtmp){
		if(objtmp[j].data.id == id){
			var sum = parseInt(objtmp[j].data.count) + num;
			objtmp[j].set('count',sum);
			break;
		}
	}
}

function removeDepotdata(id){
	var obj = titleArray[keyinfos.depotkey].infoobj;
	for(var i in obj){
		if(obj[i].id == id){
			obj.splice(i,1);
			break;
		}
	}
	saveData('depotdata');
}


function addDepotdata(gid,num){
	var configitem = getGoodsConfigItem(gid);
	var notetxt = configitem.description.toString();
	if(configitem.isuse == 't'){
		notetxt = notetxt+'<br/>点击开始使用';
	}
	depotstore.add({
		name:configitem.name.toString(),
		id:gid,
		count:num,
		lv:parseInt(configitem.lv),
		description:notetxt,
		isuse:configitem.isuse.toString()
	});
	titleArray[keyinfos.depotkey].infoobj.push({id:gid,count:num,name:configitem.name.toString()});
}

function saveData(id){
	switch(id){
		case 'mapdata':
			console.log('存储地图数据到LocalStorage');
			var item = titleArray[keyinfos.mapkey];
			saveLocaldata(item.localkey,item.infoobj);
			break;
		case 'depotdata':
			console.log('存储仓库数据到localstorage');
			var item = titleArray[keyinfos.depotkey];
			saveLocaldata(item.localkey,item.infoobj);
			break;
		case 'bugsdata':
			console.log('存储虫群数据到localstorage');
			var item = titleArray[keyinfos.bugskey];
			saveLocaldata(item.localkey,item.infoobj);
			break;
	}
}

function getMapitemByXY(x,y){
	var mapdataInfoObj = titleArray[keyinfos.mapkey].infoobj;
	var item = null;
	for(var i in mapdataInfoObj){
		item = mapdataInfoObj[i];
		if(parseInt(item.x) == x && parseInt(item.y)==y){
			return item;
		}
	}
	return item;
}

function getGoodsConfigItem(id){
	return getItem(keyinfos.goodsconfigkey,id);
}

function getGoodsDepotItem(id){
	return getItem(keyinfos.depotkey,id);
}

function getBugsConfigItem(id){
	return getItem(keyinfos.bugsconfigkey,id);
}

function getBugsDataItem(id){
	return getItem(keyinfos.bugskey,id);
}

function getItem(typeid,id){
	var obj = titleArray[typeid].infoobj;
	for(var i in obj){
		if(obj[i].id == id){
			return obj[i];
		}
	}
}

function getMapdataConfigItem(type,id){
	var targetObj = null;
	var targetItem = null;
	switch(type){
		case 'pickup':
			targetObj = titleArray[keyinfos.goodsconfigkey].infoobj;
			break;
		case 'used':
		case 'balk':
		case 'clearing':
		case 'special':
		case 'exit':
			targetObj = titleArray[keyinfos.landformconfigkey].infoobj;
			break;
	}
	for(var i in targetObj){
		var item = targetObj[i];
		if(item.id == id){
			targetItem = item;
			break;
		}
	}
	return item;
}

function saveLocaldata(key,obj){
	var txt = JSON.stringify(obj);
	localStorage[key] = txt;
}

function getMapdataIndex(x,y){
	var index = -1;
	var mapdataInfoObj = titleArray[keyinfos.mapkey].infoobj;
	for(var i=0;i<mapdataInfoObj.length;i++){
		var item = mapdataInfoObj[i];
		var xindex = item.x;
		var yindex = item.y;
		if((xindex == x) &&  (yindex==y)){
			index = i;
			break;
		}
	}
	return index;
}

function getMapdataItem(x,y){
	var mapdataInfoObj = titleArray[keyinfos.mapkey].infoobj;
	var index = getMapdataIndex(x,y);
	if(index != -1){
		return mapdataInfoObj[index];
	}else{
		return null;
	}
}

function setMapdataIndex(indexMap){
	var mapdataInfoObj = titleArray[keyinfos.mapkey].infoobj;
	if(indexMap != -1){
		var item = mapdataInfoObj[indexMap];
		item.isopen = 1;
	}else{
		console.log('setMapdataIndex Error,index = -1');
	}
}

function setMapdata(x,y){
	setMapdataIndex(getMapdataIndex(x,y));
}

function checkUseGoods(id){
	
}

var egg2imago ={
	'g0008':'w0001',
	'g0009':'w0002',
	'g0010':'w0003',
	'g0011':'w0004',
	'g0012':'w0005',
	
	'g0013':'s0001',
	'g0014':'s0002',
	'g0015':'s0003',
	'g0016':'s0004',
	'g0017':'s0005',
};

var useGoodsDic ={
	'g0008':{
		title:'孵化初级工虫卵',
		content:'虫巢可以生产初级工虫,<br\>需要有初级虫食。',
		insufficient:'对不起，你没有初级虫食',
		checkfunc:checkElementaryFood
	},
	'g0009':{
		title:'孵化中级工虫卵',
		content:'虫巢可以生产中级工虫,<br\>需要有初级虫食。',
		insufficient:'对不起，你没有初级虫食',
		checkfunc:checkElementaryFood
	},
	'g0010':{
		title:'孵化高级工虫卵',
		content:'虫巢可以生产高级工虫,<br\>需要有高级虫食。',
		insufficient:'对不起，你没有高级虫食',
		checkfunc:checkAdvancedFood
	},
	'g0011':{
		title:'孵化超级工虫卵',
		content:'虫巢可以生产超级工虫,<br\>需要有高级虫食。',
		insufficient:'对不起，你没有高级虫食',
		checkfunc:checkAdvancedFood
	},
	'g0012':{
		title:'孵化神级工虫卵',
		content:'虫巢可以生产神级工虫,<br\>需要有高级虫食。',
		insufficient:'对不起，你没有高级虫食',
		checkfunc:checkAdvancedFood
	},
	'g0013':{
		title:'孵化初级兵虫卵',
		content:'虫巢可以生产初级兵虫,<br\>需要有初级虫食。',
		insufficient:'对不起，你没有高级虫食',
		checkfunc:checkElementaryFood
	},
	'g0014':{
		title:'孵化中级兵虫卵',
		content:'虫巢可以生产中级兵虫,<br\>需要有初级虫食。',
		insufficient:'对不起，你没有初级虫食',
		checkfunc:checkElementaryFood
	},
	'g0015':{
		title:'孵化高级兵虫卵',
		content:'虫巢可以高产初级兵虫,<br\>需要有高级虫食。',
		insufficient:'对不起，你没有高级虫食',
		checkfunc:checkAdvancedFood
	}
};

function checkElementaryFood(){
	return checkFood('g0002');
}

function checkAdvancedFood(){
	return checkFood('g0003') || checkFood('g0021');
}

function checkFood(id){
	var gooditem  = getGoodsDepotItem(id);
	if(gooditem == null){
		console.log('没有虫食选项');
		return false;
	}else if(gooditem.count <=0){
		console.log('虫食数量为零');
		return false;
	}else{
		console.log('虫食条件满足');
		return true;
	}
}

var buildDic ={
	'build001':{
		0:updateCasernFun,
		1:abandonFun,
	}
}

function updateCasernFun(item,noteobj){
	item.lv = parseInt(item.lv)+1;
	noteobj.tooltiptxt = '升级兵巢成功，现在兵巢为'+item.lv.toString()+'级!';
}

function abandonFun(item,noteobj){
	item.id = 'landform003';
	noteobj.tooltiptxt = '放弃该虫穴';
	item.note ='空地';
}

var btnBgClr = "#252525";
var btnLabClr = "#EBEBEB";
function getBtnCls(){
	return 'background-color:'+btnBgClr+';color:'+btnLabClr;
}




