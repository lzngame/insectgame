var jsonData = '{"f19_19.png": [[390, 392, 44, 44], [0, 0], 0, [0, 0, 44, 44], [44, 44]], "f20_20.png": [[368, 81, 34, 32], [0, 0], 0, [0, 0, 34, 32], [34, 32]], "slice40_40.png": [[318, 291, 48, 52], [0, 0], 0, [0, 0, 48, 52], [48, 52]], "f22_22.png": [[242, 71, 54, 56], [0, 0], 0, [0, 0, 54, 56], [54, 56]], "slice72_72.png": [[182, 84, 58, 67], [0, 0], 0, [0, 0, 58, 67], [58, 67]], "f07_07.png": [[411, 78, 36, 36], [0, 0], 0, [0, 0, 36, 36], [36, 36]], "larvanum.png": [[102, 161, 82, 25], [0, 0], 1, [0, 0, 82, 25], [82, 25]], "slice68_68.png": [[187, 2, 58, 67], [0, 0], 0, [0, 0, 58, 67], [58, 67]], "slice67_67.png": [[270, 348, 48, 52], [0, 0], 0, [0, 0, 48, 52], [48, 52]], "slice18_18.png": [[84, 469, 41, 52], [0, 0], 1, [0, 0, 41, 52], [41, 52]], "slice80_80.png": [[205, 428, 33, 33], [0, 0], 0, [0, 0, 33, 33], [33, 33]], "slice57_57.png": [[267, 129, 48, 52], [0, 0], 0, [0, 0, 48, 52], [48, 52]], "f26_26.png": [[365, 345, 45, 44], [0, 0], 1, [0, 0, 45, 44], [45, 44]], "f25_25.png": [[168, 428, 35, 33], [0, 0], 0, [0, 0, 35, 33], [35, 33]], "slice46_46.png": [[129, 160, 72, 79], [0, 0], 0, [0, 0, 72, 79], [72, 79]], "slice17_17.png": [[2, 385, 56, 85], [0, 0], 0, [0, 0, 56, 85], [56, 85]], "f32_32wdf.png": [[231, 219, 19, 19], [0, 0], 0, [0, 0, 19, 19], [19, 19]], "slice29_29.png": [[282, 2, 51, 52], [0, 0], 0, [0, 0, 51, 52], [51, 52]], "slice75_75.png": [[268, 294, 48, 52], [0, 0], 0, [0, 0, 48, 52], [48, 52]], "f33_33.png": [[247, 2, 33, 56], [0, 0], 0, [0, 0, 33, 56], [33, 56]], "workegg.png": [[183, 463, 46, 45], [0, 0], 1, [0, 0, 46, 45], [46, 45]], "slice03_03.png": [[320, 345, 43, 52], [0, 0], 0, [0, 0, 43, 52], [43, 52]], "slice79_79.png": [[411, 2, 39, 37], [0, 0], 0, [0, 0, 39, 37], [39, 37]], "f34_34.png": [[176, 241, 52, 54], [0, 0], 1, [0, 0, 52, 54], [52, 54]], "slice37_37.png": [[2, 296, 87, 82], [0, 0], 1, [0, 0, 87, 82], [87, 82]], "slice77_77.png": [[232, 240, 48, 52], [0, 0], 0, [0, 0, 48, 52], [48, 52]], "slice61_61.png": [[326, 456, 48, 52], [0, 0], 0, [0, 0, 48, 52], [48, 52]], "slice28_28.png": [[298, 102, 26, 25], [0, 0], 0, [0, 0, 26, 25], [26, 25]], "insectarea.png": [[87, 380, 82, 25], [0, 0], 1, [0, 0, 82, 25], [82, 25]], "slice90_90.png": [[218, 295, 48, 52], [0, 0], 0, [0, 0, 48, 52], [48, 52]], "slice73_73.png": [[276, 457, 48, 52], [0, 0], 0, [0, 0, 48, 52], [48, 52]], "mushroomfood.png": [[75, 161, 82, 25], [0, 0], 1, [0, 0, 82, 25], [82, 25]], "f10_10.png": [[121, 84, 74, 59], [0, 0], 1, [0, 0, 74, 59], [74, 59]], "slice63_63.png": [[344, 46, 33, 33], [0, 0], 0, [0, 0, 33, 33], [33, 33]], "metadata": [[2], [], [], []], "slice42_42.png": [[282, 237, 48, 52], [0, 0], 0, [0, 0, 48, 52], [48, 52]], "slice20_20.png": [[131, 241, 43, 53], [0, 0], 0, [0, 0, 43, 53], [43, 53]], "slice94_94.png": [[48, 245, 43, 49], [0, 0], 0, [0, 0, 43, 49], [43, 49]], "slice36_36.png": [[203, 153, 62, 64], [0, 0], 0, [0, 0, 62, 64], [62, 64]], "f08_08.png": [[2, 472, 45, 38], [0, 0], 0, [0, 0, 45, 38], [45, 38]], "slice53_53.png": [[376, 449, 40, 45], [0, 0], 0, [0, 0, 40, 45], [40, 45]], "hatchspeed.png": [[113, 296, 82, 25], [0, 0], 1, [0, 0, 82, 25], [82, 25]], "larva.png": [[451, 480, 35, 28], [0, 0], 0, [0, 0, 35, 28], [35, 28]], "slice74_74.png": [[240, 403, 48, 52], [0, 0], 0, [0, 0, 48, 52], [48, 52]], "f02_122.png": [[203, 219, 20, 26], [0, 0], 1, [0, 0, 20, 26], [20, 26]], "f34_34qq.png": [[242, 129, 15, 16], [0, 0], 0, [0, 0, 15, 16], [15, 16]], "f09_09.png": [[379, 39, 27, 26], [0, 0], 0, [0, 0, 27, 26], [27, 26]], "slice131df.png": [[340, 399, 48, 48], [0, 0], 0, [0, 0, 48, 48], [48, 48]], "slice43_43.png": [[140, 296, 76, 76], [0, 0], 0, [0, 0, 76, 76], [76, 76]], "water.png": [[230, 463, 46, 44], [0, 0], 1, [0, 0, 46, 44], [46, 44]], "slice52_52.png": [[267, 183, 48, 52], [0, 0], 0, [0, 0, 48, 52], [48, 52]], "f29_29.png": [[411, 41, 35, 39], [0, 0], 1, [0, 0, 35, 39], [35, 39]], "slice33_33.png": [[93, 245, 36, 49], [0, 0], 0, [0, 0, 36, 49], [36, 49]], "slice62_62.png": [[290, 402, 48, 52], [0, 0], 0, [0, 0, 48, 52], [48, 52]], "slice64_64.png": [[114, 380, 81, 52], [0, 0], 1, [0, 0, 81, 52], [81, 52]], "mushroom.png": [[86, 296, 82, 25], [0, 0], 1, [0, 0, 82, 25], [82, 25]], "workersnum.png": [[60, 385, 82, 25], [0, 0], 1, [0, 0, 82, 25], [82, 25]], "slice82_82.png": [[168, 374, 52, 50], [0, 0], 1, [0, 0, 52, 50], [52, 50]], "f18_18.png": [[138, 463, 43, 47], [0, 0], 0, [0, 0, 43, 47], [43, 47]], "f06_06.png": [[459, 43, 37, 37], [0, 0], 0, [0, 0, 37, 37], [37, 37]], "solideregg.png": [[335, 2, 42, 42], [0, 0], 0, [0, 0, 42, 42], [42, 42]], "f03_03.png": [[459, 2, 39, 39], [0, 0], 0, [0, 0, 39, 39], [39, 39]], "slice66_66.png": [[49, 472, 33, 38], [0, 0], 0, [0, 0, 33, 38], [33, 38]], "solidersnum.png": [[48, 161, 82, 25], [0, 0], 1, [0, 0, 82, 25], [82, 25]], "slice15wq.png": [[379, 2, 28, 35], [0, 0], 0, [0, 0, 28, 35], [28, 35]], "slice76_76.png": [[220, 349, 48, 52], [0, 0], 0, [0, 0, 48, 52], [48, 52]], "slice10_10.png": [[418, 480, 30, 31], [0, 0], 1, [0, 0, 30, 31], [30, 31]], "f04_04.png": [[298, 56, 44, 44], [0, 0], 0, [0, 0, 44, 44], [44, 44]], "slice38_38.png": [[2, 161, 44, 133], [0, 0], 0, [0, 0, 44, 133], [44, 133]], "slice93_93.png": [[121, 2, 64, 80], [0, 0], 0, [0, 0, 64, 80], [64, 80]], "slice156q.png": [[2, 2, 117, 157], [0, 0], 0, [0, 0, 117, 157], [117, 157]], "f30_30.png": [[418, 438, 39, 40], [0, 0], 0, [0, 0, 39, 40], [39, 40]]}';
var jsonObj = JSON.parse(jsonData);

var mainview_Uiconfig = {
	bg:'#101420',
	hexagonfillclr:'#273F7E',
	fontclr:'#FFFFFF',
	titleClr:'#FBF7EE'
};

titleTooltipHeight = 75;
titleTooltipWidth = 260;
var clrar =['#ffccdd','#ccddff','#ededfc','#efefaa','#ccffee','#eaefea'];

var titles =['larvanum','hatchspeed','insectarea','workersnum','solidersnum','mushroom','mushroomfood'];

var tmpdata ={
	introduction:['虫巢是幼虫的孵化场所','大部分的成虫都由','对应等级的幼虫孵化而来','及时升级虫巢'],
};

var keyinfos = {
	mapkey:'mapdatakey',
	bugskey:'/getinsectinfo/bugsdata',
	depotkey:'/getinsectinfo/depotdata',
	
	goodsconfigkey:'/getinsectinfo/goodsinfo',
	bugsconfigkey:'/getinsectinfo/bugsinfo',
	landformconfigkey:'/getinsectinfo/landforminfo',
	enemyconfigkey:'/getinsectinfo/enemyinfo',
	
	homeinfokey:'/gethomedata',
}

var depotdataObjArray = [];
var bugsdataObjArray = [];

var ismapdataReady = true;

var mapArray = {
	'mapdatakey':{
		localkey:'mapdataInfo',
		infoobj:null,
		finishedid:false,
	}
};

var titleArray = {
	'/getinsectinfo/bugsdata':{
		localkey:'bugsdata',
		infoobj:null,
		finishedid:false
	},
	'/gethomedata':{
		localkey:'homedata',
		infoobj:null,
		finishedid:false
	},
	'/getinsectinfo/depotdata':{
		localkey:'depotInfo',
		infoobj:null,
		finishedid:false
	},
	'/getinsectinfo/goodsinfo':{
		localkey:'goodsconfigInfo',
		infoobj:null,
		finishedid:false
	},
	'/getinsectinfo/landforminfo':{
		localkey:'landforminfo',
		infoobj:null,
		finishedid:false
	},
	'/getinsectinfo/bugsinfo':{
		localkey:'bugsinfo',
		infoobj:null,
		finishedid:false
	},
	'/getinsectinfo/enemyinfo':{
		localkey:'enemyinfo',
		infoobj:null,
		finishedid:false
	}
};

var img_sencha = new Image();
var img_map = new Image();

function initBugsdata(){
	var objdata = titleArray[keyinfos.bugskey].infoobj;
	for(var i in objdata){
		var item = objdata[i];
		var config = getBugsConfigItem(item.id);
		bugsdataObjArray.push({
			id:item.id,
			name:config.name,
			power:item.power,
			classnote:config.classnote,
			count:item.count,
			lv:item.lv,
			description:config.description
		});
	}
	console.log('设置虫群数据');
	bugstore.setData(bugsdataObjArray);
}

function excuteBugsdata(id,num){
	var finditem = getBugsDataItem(id);
	debugger;
	if(finditem != null){
		changeItemCount(bugstore,finditem,id,num);
	}else{
		addBugsdata(id,num);
	}
	saveData('bugsdata');
}

function addBugsdata(gid,num){
	var configitem = getBugsConfigItem(gid);
	bugstore.add({
		name:configitem.name.toString(),
		id:gid,
		count:num,
		power:configitem.defaultpower,
		classnote:configitem.classnote,
		lv:parseInt(configitem.defaultlv),
		description:configitem.description.toString(),
	});
	titleArray[keyinfos.bugskey].infoobj.push({id:gid,lv:configitem.defaultlv,count:num,power:configitem.defaultpower});
}

function initDepotdata(){
	var objdata = titleArray[keyinfos.depotkey].infoobj;
	for(var i in objdata){
		var item = objdata[i];
		var config = getGoodsConfigItem(item.id);
		var notetxt = config.description;
		if(config.isuse == 't'){
			notetxt = notetxt+'<br/>点击开始使用';
		}
		var itemobj = {
			id:item.id,
			name:config.name,
			count:item.count,
			description:notetxt,
			lv:config.lv
		};
		depotdataObjArray.push(itemobj);
	}
	console.log('设置仓库数据');
	depotstore.setData(depotdataObjArray);
}

function excuteDepotdata(id,num){
	var finditem = getGoodsDepotItem(id);
	if(finditem != null){
		changeItemCount(depotstore,finditem,id,num);
	}else{
		addDepotdata(id,num);
	}
	saveData('depotdata');
}

function changeItemCount(targetstore,finditem,id,num){
	var sum = parseInt(finditem.count) + num;
	finditem.count = sum;
	
	var objtmp = targetstore.getRange();
	for(var j in objtmp){
		if(objtmp[j].data.id == id){
			var sum = parseInt(objtmp[j].data.count) + num;
			objtmp[j].set('count',sum);
			break;
		}
	}
}

function removeDepotdata(id){
	var obj = titleArray[keyinfos.depotkey].infoobj;
	for(var i in obj){
		if(obj[i].id == id){
			obj.splice(i,1);
			break;
		}
	}
	saveData('depotdata');
}


function addDepotdata(gid,num){
	var configitem = getGoodsConfigItem(gid);
	var notetxt = configitem.description.toString();
	if(configitem.isuse == 't'){
		notetxt = notetxt+'<br/>点击开始使用';
	}
	depotstore.add({
		name:configitem.name.toString(),
		id:gid,
		count:num,
		lv:parseInt(configitem.lv),
		description:notetxt,
		isuse:configitem.isuse.toString()
	});
	titleArray[keyinfos.depotkey].infoobj.push({id:gid,count:num,name:configitem.name.toString()});
}

function saveData(id){
	switch(id){
		case 'mapdata':
			console.log('存储地图数据到LocalStorage');
			var item = mapArray[keyinfos.mapkey];
			saveLocaldata(item.localkey,item.infoobj);
			break;
		case 'depotdata':
			console.log('存储仓库数据到localstorage');
			var item = titleArray[keyinfos.depotkey];
			saveLocaldata(item.localkey,item.infoobj);
			break;
		case 'bugsdata':
			console.log('存储虫群数据到localstorage');
			var item = titleArray[keyinfos.bugskey];
			saveLocaldata(item.localkey,item.infoobj);
			break;
	}
}

function getMapitemByXY(x,y){
	var mapdataInfoObj = mapArray[keyinfos.mapkey].infoobj;
	var item = null;
	for(var i in mapdataInfoObj){
		item = mapdataInfoObj[i];
		if(parseInt(item.x) == x && parseInt(item.y)==y){
			return item;
		}
	}
	return item;
}

function getGoodsConfigItem(id){
	return getItem(keyinfos.goodsconfigkey,id);
}

function getGoodsDepotItem(id){
	return getItem(keyinfos.depotkey,id);
}

function getBugsConfigItem(id){
	return getItem(keyinfos.bugsconfigkey,id);
}

function getBugsDataItem(id){
	return getItem(keyinfos.bugskey,id);
}

function getItem(typeid,id){
	var obj = titleArray[typeid].infoobj;
	for(var i in obj){
		if(obj[i].id == id){
			return obj[i];
		}
	}
}

function getMapdataConfigItem(type,id){
	var targetObj = null;
	var targetItem = null;
	switch(type){
		case 'pickup':
			targetObj = titleArray[keyinfos.goodsconfigkey].infoobj;
			break;
		case 'used':
		case 'balk':
		case 'clearing':
		case 'special':
		case 'exit':
		case 'next':
			targetObj = titleArray[keyinfos.landformconfigkey].infoobj;
			break;
	}
	for(var i in targetObj){
		var item = targetObj[i];
		if(item.id == id){
			targetItem = item;
			break;
		}
	}
	
	if(item  == null)
		debugger;
	return item;
}

function saveLocaldata(key,obj){
	var txt = JSON.stringify(obj);
	localStorage[key] = txt;
}

function getMapdataIndex(x,y){
	var index = -1;
	var mapdataInfoObj = mapArray[keyinfos.mapkey].infoobj;
	for(var i=0;i<mapdataInfoObj.length;i++){
		var item = mapdataInfoObj[i];
		var xindex = item.x;
		var yindex = item.y;
		if((xindex == x) &&  (yindex==y)){
			index = i;
			break;
		}
	}
	return index;
}

function getMapdataItem(x,y){
	var mapdataInfoObj = mapArray[keyinfos.mapkey].infoobj;
	var index = getMapdataIndex(x,y);
	if(index != -1){
		return mapdataInfoObj[index];
	}else{
		return null;
	}
}

function setMapdataIndex(indexMap){
	var mapdataInfoObj = mapArray[keyinfos.mapkey].infoobj;
	if(indexMap != -1){
		var item = mapdataInfoObj[indexMap];
		item.isopen = 1;
	}else{
		console.log('setMapdataIndex Error,index = -1');
	}
}

function setMapdata(x,y){
	setMapdataIndex(getMapdataIndex(x,y));
}

function checkUseGoods(id){
	
}

var egg2imago ={
	'g0008':'w0001',
	'g0009':'w0002',
	'g0010':'w0003',
	'g0011':'w0004',
	'g0012':'w0005',
	
	'g0013':'s0001',
	'g0014':'s0002',
	'g0015':'s0003',
	'g0016':'s0004',
	'g0017':'s0005',
};

var useGoodsDic ={
	'g0008':{
		title:'孵化初级工虫卵',
		content:'虫巢可以生产初级工虫,<br\>需要有初级虫食。',
		insufficient:'对不起，你没有初级虫食',
		checkfunc:checkElementaryFood
	},
	'g0009':{
		title:'孵化中级工虫卵',
		content:'虫巢可以生产中级工虫,<br\>需要有初级虫食。',
		insufficient:'对不起，你没有初级虫食',
		checkfunc:checkElementaryFood
	},
	'g0010':{
		title:'孵化高级工虫卵',
		content:'虫巢可以生产高级工虫,<br\>需要有高级虫食。',
		insufficient:'对不起，你没有高级虫食',
		checkfunc:checkAdvancedFood
	},
	'g0011':{
		title:'孵化超级工虫卵',
		content:'虫巢可以生产超级工虫,<br\>需要有高级虫食。',
		insufficient:'对不起，你没有高级虫食',
		checkfunc:checkAdvancedFood
	},
	'g0012':{
		title:'孵化神级工虫卵',
		content:'虫巢可以生产神级工虫,<br\>需要有高级虫食。',
		insufficient:'对不起，你没有高级虫食',
		checkfunc:checkAdvancedFood
	},
	'g0013':{
		title:'孵化初级兵虫卵',
		content:'虫巢可以生产初级兵虫,<br\>需要有初级虫食。',
		insufficient:'对不起，你没有高级虫食',
		checkfunc:checkElementaryFood
	},
	'g0014':{
		title:'孵化中级兵虫卵',
		content:'虫巢可以生产中级兵虫,<br\>需要有初级虫食。',
		insufficient:'对不起，你没有初级虫食',
		checkfunc:checkElementaryFood
	},
	'g0015':{
		title:'孵化高级兵虫卵',
		content:'虫巢可以高产初级兵虫,<br\>需要有高级虫食。',
		insufficient:'对不起，你没有高级虫食',
		checkfunc:checkAdvancedFood
	}
};

function checkElementaryFood(){
	return checkFood('g0002');
}

function checkAdvancedFood(){
	return checkFood('g0003') || checkFood('g0021');
}

function checkFood(id){
	var gooditem  = getGoodsDepotItem(id);
	if(gooditem == null){
		console.log('没有虫食选项');
		return false;
	}else if(gooditem.count <=0){
		console.log('虫食数量为零');
		return false;
	}else{
		console.log('虫食条件满足');
		return true;
	}
}

var buildDic ={
	'build001':{
		0:updateCasernFun,
		1:abandonFun,
	},
	'build002':{
		0:updateWorksiteFun,
		1:abandonFun,
	},
	'build003':{
		0:updateMushroomFun,
		1:abandonFun,
	}
}

function updateCasernFun(item,noteobj){
	item.lv = parseInt(item.lv)+1;
	noteobj.tooltiptxt = '升级兵巢成功，现在兵巢为'+item.lv.toString()+'级!';
}

function updateWorksiteFun(item,noteobj){
	item.lv = parseInt(item.lv)+1;
	noteobj.tooltiptxt = '升级工巢成功，现在工巢为'+item.lv.toString()+'级!';
}

function updateMushroomFun(item,noteobj){
	item.lv = parseInt(item.lv)+1;
	noteobj.tooltiptxt = '升级菌蒲成功，现在菌蒲为'+item.lv.toString()+'级!';
}

function abandonFun(item,noteobj){
	item.id = 'landform003';
	noteobj.tooltiptxt = '放弃该虫穴';
	item.note ='空地';
	item.lv = 0;
}

var btnBgClr = "#252525";
var btnLabClr = "#EBEBEB";
function getBtnCls(){
	return 'background-color:'+btnBgClr+';color:'+btnLabClr;
}




